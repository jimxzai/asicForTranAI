syntax = "proto3";

package gazillioner.v1;

option go_package = "github.com/gazillioner/gazillioner/api/v1;apiv1";

import "google/protobuf/timestamp.proto";
import "api/proto/v1/common.proto";

// ============================================================================
// Market Data Service
// ============================================================================

service MarketService {
  // Quotes
  rpc GetQuote(GetQuoteRequest) returns (Quote);
  rpc GetQuotes(GetQuotesRequest) returns (GetQuotesResponse);

  // Historical data
  rpc GetHistory(GetHistoryRequest) returns (GetHistoryResponse);
  rpc GetChart(GetChartRequest) returns (GetChartResponse);

  // Search and validation
  rpc SearchTickers(SearchTickersRequest) returns (SearchTickersResponse);
  rpc ValidateTicker(ValidateTickerRequest) returns (ValidateTickerResponse);

  // Market status
  rpc GetMarketStatus(Empty) returns (MarketStatus);
}

// ============================================================================
// Messages: Quotes
// ============================================================================

message GetQuoteRequest {
  string ticker = 1;
}

message GetQuotesRequest {
  repeated string tickers = 1;
}

message GetQuotesResponse {
  repeated Quote quotes = 1;
  repeated string failed_tickers = 2;         // Tickers that couldn't be fetched
}

message Quote {
  string ticker = 1;
  string name = 2;
  string exchange = 3;
  string currency = 4;

  Decimal price = 10;
  Decimal change = 11;
  Decimal change_percent = 12;
  Decimal open = 13;
  Decimal high = 14;
  Decimal low = 15;
  Decimal previous_close = 16;
  int64 volume = 17;
  int64 avg_volume = 18;

  Decimal market_cap = 20;
  Decimal pe_ratio = 21;
  Decimal dividend_yield = 22;
  Decimal high_52w = 23;
  Decimal low_52w = 24;

  google.protobuf.Timestamp timestamp = 30;
  bool is_delayed = 31;                       // True if delayed quotes
  int32 delay_minutes = 32;                   // Delay in minutes (typically 15)
}

// ============================================================================
// Messages: Historical Data
// ============================================================================

message GetHistoryRequest {
  string ticker = 1;

  enum Interval {
    INTERVAL_UNSPECIFIED = 0;
    INTERVAL_1D = 1;                          // Daily
    INTERVAL_1W = 2;                          // Weekly
    INTERVAL_1M = 3;                          // Monthly
  }
  Interval interval = 2;

  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
  int32 limit = 5;                            // Max data points (default: 365)
}

message GetHistoryResponse {
  string ticker = 1;
  Interval interval = 2;
  repeated OHLCV data = 3;
}

message OHLCV {
  google.protobuf.Timestamp timestamp = 1;
  Decimal open = 2;
  Decimal high = 3;
  Decimal low = 4;
  Decimal close = 5;
  int64 volume = 6;
  Decimal adjusted_close = 7;                 // Adjusted for splits/dividends
}

enum Interval {
  INTERVAL_UNSPECIFIED = 0;
  INTERVAL_1D = 1;
  INTERVAL_1W = 2;
  INTERVAL_1M = 3;
}

// ============================================================================
// Messages: Charts
// ============================================================================

message GetChartRequest {
  string ticker = 1;

  enum Period {
    PERIOD_UNSPECIFIED = 0;
    PERIOD_1D = 1;
    PERIOD_1W = 2;
    PERIOD_1M = 3;
    PERIOD_3M = 4;
    PERIOD_1Y = 5;
    PERIOD_5Y = 6;
  }
  Period period = 2;

  int32 width = 3;                            // Chart width in characters
  int32 height = 4;                           // Chart height in lines
}

message GetChartResponse {
  string ticker = 1;
  Period period = 2;
  string ascii_chart = 3;                     // ASCII art chart for TUI
  repeated ChartDataPoint data = 4;           // Raw data for custom rendering
  ChartStats stats = 5;
}

enum Period {
  PERIOD_UNSPECIFIED = 0;
  PERIOD_1D = 1;
  PERIOD_1W = 2;
  PERIOD_1M = 3;
  PERIOD_3M = 4;
  PERIOD_1Y = 5;
  PERIOD_5Y = 6;
}

message ChartDataPoint {
  google.protobuf.Timestamp timestamp = 1;
  Decimal value = 2;
}

message ChartStats {
  Decimal min = 1;
  Decimal max = 2;
  Decimal start = 3;
  Decimal end = 4;
  Decimal change = 5;
  Decimal change_percent = 6;
}

// ============================================================================
// Messages: Search and Validation
// ============================================================================

message SearchTickersRequest {
  string query = 1;                           // Search term
  int32 limit = 2;                            // Max results (default: 10)

  enum AssetType {
    ASSET_TYPE_UNSPECIFIED = 0;
    ASSET_TYPE_STOCK = 1;
    ASSET_TYPE_ETF = 2;
    ASSET_TYPE_MUTUAL_FUND = 3;
    ASSET_TYPE_CRYPTO = 4;
  }
  AssetType filter_type = 3;
}

message SearchTickersResponse {
  repeated TickerResult results = 1;
}

message TickerResult {
  string ticker = 1;
  string name = 2;
  string exchange = 3;
  string type = 4;                            // "Stock", "ETF", "Crypto", etc.
  string sector = 5;
  string industry = 6;
}

message ValidateTickerRequest {
  string ticker = 1;
}

message ValidateTickerResponse {
  bool valid = 1;
  string ticker = 2;                          // Normalized ticker
  string name = 3;
  string type = 4;
  string exchange = 5;
  string message = 6;                         // Error message if invalid
}

// ============================================================================
// Messages: Market Status
// ============================================================================

message MarketStatus {
  enum State {
    STATE_UNSPECIFIED = 0;
    STATE_PRE_MARKET = 1;
    STATE_OPEN = 2;
    STATE_CLOSED = 3;
    STATE_AFTER_HOURS = 4;
  }

  State us_market = 1;
  State crypto_market = 2;                    // Always OPEN

  google.protobuf.Timestamp next_open = 3;
  google.protobuf.Timestamp next_close = 4;

  string timezone = 5;                        // e.g., "America/New_York"
  google.protobuf.Timestamp server_time = 6;

  // Data source status
  bool yahoo_finance_available = 10;
  int32 quote_delay_minutes = 11;
  google.protobuf.Timestamp last_quote_update = 12;
}
