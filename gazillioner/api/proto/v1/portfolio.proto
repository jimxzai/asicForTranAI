syntax = "proto3";

package gazillioner.v1;

option go_package = "github.com/gazillioner/gazillioner/api/v1;apiv1";

import "google/protobuf/timestamp.proto";
import "api/proto/v1/common.proto";

// ============================================================================
// Portfolio Service - Multi-Portfolio Support
// ============================================================================

service PortfolioService {
  // Portfolio CRUD
  rpc ListPortfolios(ListPortfoliosRequest) returns (ListPortfoliosResponse);
  rpc GetPortfolio(GetPortfolioRequest) returns (Portfolio);
  rpc CreatePortfolio(CreatePortfolioRequest) returns (Portfolio);
  rpc UpdatePortfolio(UpdatePortfolioRequest) returns (Portfolio);
  rpc DeletePortfolio(DeletePortfolioRequest) returns (Empty);
  rpc SetDefaultPortfolio(SetDefaultPortfolioRequest) returns (Portfolio);

  // Holdings CRUD (scoped to portfolio)
  rpc ListHoldings(ListHoldingsRequest) returns (ListHoldingsResponse);
  rpc GetHolding(GetHoldingRequest) returns (Holding);
  rpc AddHolding(AddHoldingRequest) returns (Holding);
  rpc UpdateHolding(UpdateHoldingRequest) returns (Holding);
  rpc DeleteHolding(DeleteHoldingRequest) returns (Empty);
  rpc MoveHolding(MoveHoldingRequest) returns (Holding); // Move between portfolios

  // Bulk operations
  rpc ImportHoldings(ImportHoldingsRequest) returns (ImportHoldingsResponse);
  rpc ExportHoldings(ExportHoldingsRequest) returns (ExportHoldingsResponse);

  // Portfolio summary (can be for single or aggregated)
  rpc GetPortfolioSummary(GetPortfolioSummaryRequest) returns (PortfolioSummary);
  rpc GetAggregatedSummary(GetAggregatedSummaryRequest) returns (PortfolioSummary);
  rpc GetAllocation(GetAllocationRequest) returns (AllocationResponse);
  rpc GetPerformance(GetPerformanceRequest) returns (PerformanceResponse);
}

// ============================================================================
// Watchlist Service
// ============================================================================

service WatchlistService {
  rpc ListWatchlist(ListWatchlistRequest) returns (ListWatchlistResponse);
  rpc AddToWatchlist(AddToWatchlistRequest) returns (WatchlistItem);
  rpc RemoveFromWatchlist(RemoveFromWatchlistRequest) returns (Empty);
  rpc UpdateWatchlistItem(UpdateWatchlistItemRequest) returns (WatchlistItem);
}

// ============================================================================
// Messages: Portfolio
// ============================================================================

message Portfolio {
  string id = 1;
  string name = 2;
  string description = 3;
  PortfolioType portfolio_type = 4;
  string currency = 5;
  bool is_default = 6;
  string color = 7;                           // Hex color for UI
  string icon = 8;                            // Icon name for UI
  string benchmark_ticker = 9;                // e.g., "SPY"

  // Computed summary (populated by service)
  Decimal total_value = 10;
  Decimal total_cost = 11;
  Decimal total_gain_loss = 12;
  Decimal total_gain_loss_percent = 13;
  Decimal day_change = 14;
  Decimal day_change_percent = 15;
  int32 holdings_count = 16;

  google.protobuf.Timestamp created_at = 30;
  google.protobuf.Timestamp updated_at = 31;
}

enum PortfolioType {
  PORTFOLIO_TYPE_UNSPECIFIED = 0;
  PORTFOLIO_TYPE_INVESTMENT = 1;
  PORTFOLIO_TYPE_RETIREMENT = 2;
  PORTFOLIO_TYPE_TRADING = 3;
  PORTFOLIO_TYPE_CRYPTO = 4;
  PORTFOLIO_TYPE_REAL_ESTATE = 5;
  PORTFOLIO_TYPE_EDUCATION = 6;
  PORTFOLIO_TYPE_EMERGENCY = 7;
  PORTFOLIO_TYPE_CUSTOM = 8;
}

message ListPortfoliosRequest {
  PaginationRequest pagination = 1;
  bool include_summary = 2;                   // Include computed totals
}

message ListPortfoliosResponse {
  repeated Portfolio portfolios = 1;
  PaginationResponse pagination = 2;
  PortfolioSummary aggregated_summary = 3;    // Summary across all portfolios
}

message GetPortfolioRequest {
  string id = 1;
  bool include_holdings = 2;                  // Include holdings in response
}

message CreatePortfolioRequest {
  string name = 1;
  string description = 2;
  PortfolioType portfolio_type = 3;
  string currency = 4;
  bool is_default = 5;
  string color = 6;
  string icon = 7;
  string benchmark_ticker = 8;
}

message UpdatePortfolioRequest {
  string id = 1;
  string name = 2;
  string description = 3;
  PortfolioType portfolio_type = 4;
  bool is_default = 5;
  string color = 6;
  string icon = 7;
  string benchmark_ticker = 8;
}

message DeletePortfolioRequest {
  string id = 1;
  bool delete_holdings = 2;                   // If false, moves to default portfolio
}

message SetDefaultPortfolioRequest {
  string id = 1;
}

// ============================================================================
// Messages: Holdings
// ============================================================================

message Holding {
  string id = 1;                              // Unique identifier
  string portfolio_id = 2;                    // Parent portfolio ID
  string ticker = 3;                          // Stock/ETF/crypto ticker
  string name = 4;                            // Security name
  Decimal quantity = 5;                       // Number of shares/units
  Decimal cost_basis = 6;                     // Cost per share at acquisition
  google.protobuf.Timestamp acquisition_date = 7;
  string notes = 8;                           // User notes

  // Computed fields (populated by service)
  Decimal current_price = 10;
  Decimal current_value = 11;                 // quantity * current_price
  Decimal total_cost = 12;                    // quantity * cost_basis
  Decimal gain_loss = 13;                     // current_value - total_cost
  Decimal gain_loss_percent = 14;
  Decimal day_change = 15;
  Decimal day_change_percent = 16;

  // Metadata
  AssetClass asset_class = 20;
  string sector = 21;
  string exchange = 22;

  google.protobuf.Timestamp created_at = 30;
  google.protobuf.Timestamp updated_at = 31;
}

enum AssetClass {
  ASSET_CLASS_UNSPECIFIED = 0;
  ASSET_CLASS_STOCK = 1;
  ASSET_CLASS_ETF = 2;
  ASSET_CLASS_MUTUAL_FUND = 3;
  ASSET_CLASS_BOND = 4;
  ASSET_CLASS_CRYPTO = 5;
  ASSET_CLASS_CASH = 6;
  ASSET_CLASS_OTHER = 7;
}

message ListHoldingsRequest {
  string portfolio_id = 1;                    // Required: which portfolio
  PaginationRequest pagination = 2;
  AssetClass filter_asset_class = 3;
  string filter_sector = 4;
}

message MoveHoldingRequest {
  string holding_id = 1;
  string target_portfolio_id = 2;
}

message ListHoldingsResponse {
  repeated Holding holdings = 1;
  PaginationResponse pagination = 2;
}

message GetHoldingRequest {
  string id = 1;
}

message AddHoldingRequest {
  string portfolio_id = 1;                    // Required: target portfolio
  string ticker = 2;
  Decimal quantity = 3;
  Decimal cost_basis = 4;
  google.protobuf.Timestamp acquisition_date = 5;
  string notes = 6;
}

message UpdateHoldingRequest {
  string id = 1;
  Decimal quantity = 2;
  Decimal cost_basis = 3;
  google.protobuf.Timestamp acquisition_date = 4;
  string notes = 5;
}

message DeleteHoldingRequest {
  string id = 1;
}

message ImportHoldingsRequest {
  string portfolio_id = 1;                    // Target portfolio
  bytes csv_data = 2;
  map<string, string> column_mapping = 3;  // Maps CSV columns to Holding fields
}

message ImportHoldingsResponse {
  int32 imported_count = 1;
  int32 skipped_count = 2;
  repeated string errors = 3;
}

message ExportHoldingsRequest {
  string portfolio_id = 1;                    // Empty = all portfolios
  enum Format {
    FORMAT_UNSPECIFIED = 0;
    FORMAT_CSV = 1;
    FORMAT_JSON = 2;
  }
  Format format = 2;
}

message ExportHoldingsResponse {
  bytes data = 1;
  string filename = 2;
  string content_type = 3;
}

// ============================================================================
// Messages: Portfolio Summary
// ============================================================================

message GetPortfolioSummaryRequest {
  string portfolio_id = 1;                    // Specific portfolio (empty = default)
}

message GetAggregatedSummaryRequest {
  repeated string portfolio_ids = 1;          // Empty = all portfolios
}

message PortfolioSummary {
  string portfolio_id = 1;                    // Empty if aggregated
  string portfolio_name = 2;
  Decimal total_value = 3;
  Decimal total_cost = 4;
  Decimal total_gain_loss = 5;
  Decimal total_gain_loss_percent = 6;
  Decimal day_change = 7;
  Decimal day_change_percent = 8;
  int32 holdings_count = 9;
  int32 portfolios_count = 10;                // For aggregated summaries
  google.protobuf.Timestamp last_updated = 11;
}

message GetAllocationRequest {
  string portfolio_id = 1;                    // Empty = all portfolios
  enum GroupBy {
    GROUP_BY_UNSPECIFIED = 0;
    GROUP_BY_ASSET_CLASS = 1;
    GROUP_BY_SECTOR = 2;
    GROUP_BY_TICKER = 3;
    GROUP_BY_PORTFOLIO = 4;                   // New: group by portfolio
  }
  GroupBy group_by = 2;
}

message AllocationResponse {
  repeated AllocationItem items = 1;
}

message AllocationItem {
  string label = 1;
  Decimal value = 2;
  Decimal percentage = 3;
}

message GetPerformanceRequest {
  string portfolio_id = 1;                    // Empty = all portfolios
  enum Period {
    PERIOD_UNSPECIFIED = 0;
    PERIOD_1D = 1;
    PERIOD_1W = 2;
    PERIOD_1M = 3;
    PERIOD_3M = 4;
    PERIOD_1Y = 5;
    PERIOD_YTD = 6;
    PERIOD_ALL = 7;
  }
  Period period = 2;
}

message PerformanceResponse {
  repeated PerformanceDataPoint data_points = 1;
  Decimal period_return = 2;
  Decimal period_return_percent = 3;
  Decimal benchmark_return = 4;         // S&P 500 comparison
  Decimal benchmark_return_percent = 5;
}

message PerformanceDataPoint {
  google.protobuf.Timestamp timestamp = 1;
  Decimal value = 2;
}

// ============================================================================
// Messages: Watchlist
// ============================================================================

message WatchlistItem {
  string id = 1;
  string ticker = 2;
  string name = 3;
  Decimal current_price = 4;
  Decimal day_change = 5;
  Decimal day_change_percent = 6;
  Decimal high_52w = 7;
  Decimal low_52w = 8;
  string notes = 9;
  google.protobuf.Timestamp added_at = 10;
}

message ListWatchlistRequest {
  PaginationRequest pagination = 1;
}

message ListWatchlistResponse {
  repeated WatchlistItem items = 1;
  PaginationResponse pagination = 2;
}

message AddToWatchlistRequest {
  string ticker = 1;
  string notes = 2;
}

message RemoveFromWatchlistRequest {
  string ticker = 1;
}

message UpdateWatchlistItemRequest {
  string ticker = 1;
  string notes = 2;
}
