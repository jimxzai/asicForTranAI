name: æ¯å‘¨å‘¨è®ºè‡ªåŠ¨ç”Ÿæˆ

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC (åŒ—äº¬æ—¶é—´ 08:00) è‡ªåŠ¨è¿è¡Œ
    - cron: '0 0 * * 6'

  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-weekly-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…Pandocå’ŒLaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-plain-generic \
            fonts-noto-cjk

      - name: Agent 5 - å‡ºä¹¦æ€»ç®¡ï¼ˆå‘¨æŠ¥æ¨¡å¼ï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 5: å‡ºä¹¦æ€»ç®¡ï¼ˆå‘¨æŠ¥æ¨¡å¼ï¼‰"
          cd books-ai-publishing

          # è·å–å½“å‰å‘¨æ•°
          WEEK_NUM=$(date +%V)
          YEAR=$(date +%Y)

          python3 scripts/agent5_publisher.py \
            --mode weekly \
            --week $WEEK_NUM \
            --year $YEAR

      - name: ç”ŸæˆPDFå‘¨æŠ¥
        run: |
          cd books-ai-publishing/proofread/weekly

          # æ‰¾åˆ°æœ€æ–°ç”Ÿæˆçš„å‘¨è®ºmarkdown
          LATEST_WEEKLY=$(ls -t week-*.md 2>/dev/null | head -1)

          if [ -n "$LATEST_WEEKLY" ]; then
            echo "ç”ŸæˆPDF: $LATEST_WEEKLY"

            pandoc "$LATEST_WEEKLY" \
              --from markdown \
              --to pdf \
              --pdf-engine=xelatex \
              --template=eisvogel \
              -V CJKmainfont="Noto Serif CJK SC" \
              -V fontsize=11pt \
              -V geometry:margin=1in \
              --toc \
              --number-sections \
              -o "${LATEST_WEEKLY%.md}.pdf"

            echo "âœ… PDFç”Ÿæˆå®Œæˆ: ${LATEST_WEEKLY%.md}.pdf"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å‘¨è®ºmarkdownæ–‡ä»¶"
          fi

      - name: ç»Ÿè®¡æœ¬å‘¨è¿›åº¦
        run: |
          cd books-ai-publishing

          echo "ğŸ“Š æœ¬å‘¨å­¦ä¹ ç»Ÿè®¡"
          echo "================="

          # ç»Ÿè®¡æœ¬å‘¨æ–°å¢çš„æ–‡ä»¶æ•°
          WEEK_START=$(date -d "7 days ago" +%Y-%m-%d)
          DRAFTS_COUNT=$(find drafts -name "*.md" -newermt "$WEEK_START" | wc -l)

          echo "ğŸ“ æœ¬å‘¨å¿ƒå¾—æ•°: $DRAFTS_COUNT"

          # ç»Ÿè®¡å­—æ•°
          if [ $DRAFTS_COUNT -gt 0 ]; then
            TOTAL_CHARS=$(find drafts -name "*.md" -newermt "$WEEK_START" -exec wc -m {} + | tail -1 | awk '{print $1}')
            echo "ğŸ“Š æ€»å­—æ•°: $TOTAL_CHARS"
          fi

          echo "================="

      - name: æäº¤å‘¨æŠ¥
        run: |
          git config --global user.name "AI Publishing Bot"
          git config --global user.email "ai-bot@three-books.ai"

          git add books-ai-publishing/proofread/weekly/

          WEEK_NUM=$(date +%V)
          git commit -m "feat: ç”Ÿæˆç¬¬${WEEK_NUM}å‘¨å‘¨è®º

          - âœ… 5000å­—å‘¨è®ºå®Œæˆ
          - âœ… PDFå‘¨æŠ¥ç”Ÿæˆ
          - ğŸ“Š æœ¬å‘¨å­¦ä¹ è¿›åº¦ç»Ÿè®¡

          Generated by AI Publishing System"

          git push

      - name: åˆ›å»ºGitHub Releaseï¼ˆæ¯æœˆé¦–ä¸ªå‘¨å…­ï¼‰
        if: github.event.schedule != ''
        run: |
          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬æœˆç¬¬ä¸€ä¸ªå‘¨å…­
          DAY_OF_MONTH=$(date +%d)

          if [ $DAY_OF_MONTH -le 7 ]; then
            echo "ğŸ“¦ åˆ›å»ºæœˆåº¦Release"

            MONTH=$(date +%Y-%m)
            WEEK_NUM=$(date +%V)

            gh release create "weekly-$MONTH" \
              books-ai-publishing/proofread/weekly/week-$WEEK_NUM-*.pdf \
              --title "æœˆåº¦å‘¨è®ºåˆé›† - $MONTH" \
              --notes "æœ¬æœˆæ‰€æœ‰å‘¨è®ºçš„PDFåˆé›†"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘é€å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… å‘¨è®ºç”ŸæˆæˆåŠŸ"
          echo "ğŸ“… å‘¨æ•°: $(date +%V)"
          echo "ğŸ“„ PDFå·²ç”Ÿæˆ"
