name: å­£åº¦ä¹¦ç¨¿è‡ªåŠ¨ç”Ÿæˆ

on:
  schedule:
    # æ¯å­£åº¦æœ€åä¸€å¤© 23:59 UTC
    # 3æœˆ31æ—¥ã€6æœˆ30æ—¥ã€9æœˆ30æ—¥ã€12æœˆ31æ—¥
    - cron: '59 23 31 3,6,9,12 *'

  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      quarter:
        description: 'å­£åº¦ (1-4)'
        required: true
        default: '4'
      year:
        description: 'å¹´ä»½'
        required: true
        default: '2025'

jobs:
  generate-quarterly-book:
    runs-on: ubuntu-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…Pandocå’ŒLaTeXå®Œæ•´å·¥å…·é“¾
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-full \
            fonts-noto-cjk \
            fonts-noto-cjk-extra \
            calibre

      - name: ç¡®å®šå­£åº¦ä¿¡æ¯
        id: quarter_info
        run: |
          if [ -n "${{ github.event.inputs.quarter }}" ]; then
            QUARTER=${{ github.event.inputs.quarter }}
            YEAR=${{ github.event.inputs.year }}
          else
            MONTH=$(date +%m)
            YEAR=$(date +%Y)
            QUARTER=$(( ($MONTH - 1) / 3 + 1 ))
          fi

          echo "quarter=$QUARTER" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "ğŸ“… æ­£åœ¨ç”Ÿæˆ ${YEAR}Q${QUARTER} å­£åº¦ä¹¦ç¨¿"

      - name: Agent 5 - å‡ºä¹¦æ€»ç®¡ï¼ˆå­£åº¦æ¨¡å¼ï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 5: å‡ºä¹¦æ€»ç®¡ï¼ˆå­£åº¦æ¨¡å¼ï¼‰"
          cd books-ai-publishing

          python3 scripts/agent5_publisher.py \
            --mode quarterly \
            --quarter ${{ steps.quarter_info.outputs.quarter }} \
            --year ${{ steps.quarter_info.outputs.year }}

      - name: ç”Ÿæˆå¤šæ ¼å¼ä¹¦ç¨¿
        run: |
          cd books-ai-publishing/books

          QUARTER=${{ steps.quarter_info.outputs.quarter }}
          YEAR=${{ steps.quarter_info.outputs.year }}

          # æ‰¾åˆ°æœ€æ–°ç”Ÿæˆçš„å­£åº¦markdown
          LATEST_BOOK="quarterly-${YEAR}-Q${QUARTER}.md"

          if [ -f "$LATEST_BOOK" ]; then
            echo "ğŸ“š ç”Ÿæˆå¤šæ ¼å¼ä¹¦ç¨¿: $LATEST_BOOK"

            # 1. ç”Ÿæˆé«˜è´¨é‡PDFï¼ˆé€‚åˆæ‰“å°ï¼‰
            echo "ç”ŸæˆPDF..."
            pandoc "$LATEST_BOOK" \
              --from markdown \
              --to pdf \
              --pdf-engine=xelatex \
              --template=eisvogel \
              -V CJKmainfont="Noto Serif CJK SC" \
              -V fontsize=11pt \
              -V geometry:a5paper \
              -V geometry:margin=0.75in \
              -V documentclass=book \
              -V classoption=twoside \
              --toc \
              --toc-depth=3 \
              --number-sections \
              --listings \
              -o "sunzi-${YEAR}-Q${QUARTER}.pdf"

            # 2. ç”ŸæˆEPUBï¼ˆç”µå­ä¹¦ï¼‰
            echo "ç”ŸæˆEPUB..."
            pandoc "$LATEST_BOOK" \
              --from markdown \
              --to epub3 \
              --toc \
              --toc-depth=3 \
              --epub-cover-image=cover.jpg \
              --css=style.css \
              --metadata title="å­™å­å…µæ³•Â·AIæ—¶ä»£è§£è¯» (${YEAR} Q${QUARTER})" \
              --metadata author="Jim Xiao" \
              --metadata lang=zh-CN \
              -o "sunzi-${YEAR}-Q${QUARTER}.epub"

            # 3. ç”ŸæˆMOBIï¼ˆKindleæ ¼å¼ï¼‰
            echo "ç”ŸæˆMOBI..."
            ebook-convert "sunzi-${YEAR}-Q${QUARTER}.epub" \
              "sunzi-${YEAR}-Q${QUARTER}.mobi" \
              --no-inline-toc

            # 4. ç”ŸæˆLaTeXæºç ï¼ˆä¸“ä¸šæ’ç‰ˆï¼‰
            echo "ç”ŸæˆLaTeX..."
            pandoc "$LATEST_BOOK" \
              --from markdown \
              --to latex \
              --standalone \
              --template=template.tex \
              --listings \
              --number-sections \
              --toc \
              -V documentclass=book \
              -V classoption=twoside \
              -V fontsize=11pt \
              -V geometry:a5paper \
              -V CJKmainfont="Noto Serif CJK SC" \
              -o "sunzi-${YEAR}-Q${QUARTER}.tex"

            echo "âœ… æ‰€æœ‰æ ¼å¼ç”Ÿæˆå®Œæˆï¼"
            ls -lh sunzi-${YEAR}-Q${QUARTER}.*
          else
            echo "âŒ æœªæ‰¾åˆ°markdownæºæ–‡ä»¶: $LATEST_BOOK"
            exit 1
          fi

      - name: ç”Ÿæˆå­£åº¦ç»Ÿè®¡æŠ¥å‘Š
        run: |
          cd books-ai-publishing

          QUARTER=${{ steps.quarter_info.outputs.quarter }}
          YEAR=${{ steps.quarter_info.outputs.year }}

          echo "ğŸ“Š ${YEAR}Q${QUARTER} å­¦ä¹ ç»Ÿè®¡" > quarter-stats.md
          echo "=====================" >> quarter-stats.md
          echo "" >> quarter-stats.md

          # è®¡ç®—å­£åº¦çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
          START_MONTH=$(( ($QUARTER - 1) * 3 + 1 ))
          END_MONTH=$(( $QUARTER * 3 ))

          START_DATE="${YEAR}-$(printf "%02d" $START_MONTH)-01"
          END_DATE="${YEAR}-$(printf "%02d" $END_MONTH)-31"

          # ç»Ÿè®¡å¿ƒå¾—æ•°é‡
          DRAFTS_COUNT=$(find drafts -name "*.md" -newermt "$START_DATE" ! -newermt "$END_DATE" 2>/dev/null | wc -l)
          echo "ğŸ“ æœ¬å­£åº¦å¿ƒå¾—æ•°: $DRAFTS_COUNT" >> quarter-stats.md

          # ç»Ÿè®¡å­—æ•°
          if [ $DRAFTS_COUNT -gt 0 ]; then
            TOTAL_CHARS=$(find drafts -name "*.md" -newermt "$START_DATE" ! -newermt "$END_DATE" -exec wc -m {} + 2>/dev/null | tail -1 | awk '{print $1}')
            echo "ğŸ“Š æ€»å­—æ•°: $TOTAL_CHARS" >> quarter-stats.md
          fi

          # ç»Ÿè®¡ä¹¦ç±è¿›åº¦
          SUNZI_COUNT=$(find annotations/sunzi -name "*.md" 2>/dev/null | wc -l)
          echo "ğŸ“– ã€Šå­™å­å…µæ³•ã€‹è¿›åº¦: $SUNZI_COUNT / 13ç¯‡" >> quarter-stats.md

          ZIZHI_COUNT=$(find annotations/zizhi -name "*.md" 2>/dev/null | wc -l)
          echo "ğŸ“– ã€Šèµ„æ²»é€šé‰´ã€‹è¿›åº¦: $ZIZHI_COUNT / 294å·" >> quarter-stats.md

          BIBLE_COUNT=$(find annotations/bible -name "*.md" 2>/dev/null | wc -l)
          echo "ğŸ“– ã€Šåœ£ç»ã€‹è¿›åº¦: $BIBLE_COUNT / 1189ç« " >> quarter-stats.md

          echo "" >> quarter-stats.md
          echo "ğŸ¯ 7å¹´å¤§ä¸šè¿›åº¦: $(date +%Y)-Q${QUARTER} / 2032-Q4" >> quarter-stats.md

          cat quarter-stats.md

      - name: æäº¤ä¹¦ç¨¿å’Œç»Ÿè®¡
        run: |
          git config --global user.name "AI Publishing Bot"
          git config --global user.email "ai-bot@three-books.ai"

          git add books-ai-publishing/books/
          git add books-ai-publishing/quarter-stats.md

          QUARTER=${{ steps.quarter_info.outputs.quarter }}
          YEAR=${{ steps.quarter_info.outputs.year }}

          git commit -m "feat: ç”Ÿæˆ${YEAR}Q${QUARTER}å­£åº¦ä¹¦ç¨¿

          - âœ… 5ä¸‡å­—ä¸“ç« å®Œæˆ
          - âœ… å¤šæ ¼å¼ä¹¦ç¨¿ç”Ÿæˆï¼ˆPDF + EPUB + MOBI + LaTeXï¼‰
          - ğŸ“Š å­£åº¦å­¦ä¹ ç»Ÿè®¡

          Generated by AI Publishing System"

          git push

      - name: åˆ›å»ºGitHub Release
        run: |
          QUARTER=${{ steps.quarter_info.outputs.quarter }}
          YEAR=${{ steps.quarter_info.outputs.year }}

          gh release create "quarterly-${YEAR}-Q${QUARTER}" \
            books-ai-publishing/books/sunzi-${YEAR}-Q${QUARTER}.pdf \
            books-ai-publishing/books/sunzi-${YEAR}-Q${QUARTER}.epub \
            books-ai-publishing/books/sunzi-${YEAR}-Q${QUARTER}.mobi \
            books-ai-publishing/quarter-stats.md \
            --title "ğŸ“š ${YEAR}Q${QUARTER} å­£åº¦ä¹¦ç¨¿" \
            --notes "$(cat books-ai-publishing/quarter-stats.md)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘é€å®Œæˆé€šçŸ¥
        if: success()
        run: |
          QUARTER=${{ steps.quarter_info.outputs.quarter }}
          YEAR=${{ steps.quarter_info.outputs.year }}

          echo "âœ… ${YEAR}Q${QUARTER} å­£åº¦ä¹¦ç¨¿ç”ŸæˆæˆåŠŸï¼"
          echo "ğŸ“š PDFã€EPUBã€MOBIã€LaTeX å…¨éƒ¨ç”Ÿæˆ"
          echo "ğŸ“¦ å·²åˆ›å»ºGitHub Release"
          echo "ğŸ‰ 7å¹´è®¡åˆ’ç»§ç»­å‰è¿›ï¼"
