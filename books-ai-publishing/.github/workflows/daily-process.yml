name: æ¯æ—¥AIæ³¨ç–è‡ªåŠ¨åŒ–å¤„ç†

on:
  schedule:
    # æ¯å¤© 23:59 UTC (åŒ—äº¬æ—¶é—´ 07:59) è‡ªåŠ¨è¿è¡Œ
    - cron: '59 23 * * *'

  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      draft_file:
        description: 'è¦å¤„ç†çš„draftæ–‡ä»¶åï¼ˆå¦‚ï¼š2025-12-03.mdï¼‰'
        required: false
        default: ''

jobs:
  process-daily-draft:
    runs-on: ubuntu-latest

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰æ–°çš„draftæ–‡ä»¶
        id: check_draft
        run: |
          cd books-ai-publishing/drafts
          TODAY=$(date +%Y-%m-%d)

          if [ -n "${{ github.event.inputs.draft_file }}" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨æŒ‡å®šæ–‡ä»¶
            DRAFT_FILE="${{ github.event.inputs.draft_file }}"
          else
            # è‡ªåŠ¨è§¦å‘æ—¶ä½¿ç”¨ä»Šæ—¥æ–‡ä»¶
            DRAFT_FILE="${TODAY}.md"
          fi

          if [ -f "$DRAFT_FILE" ]; then
            echo "å‘ç°draftæ–‡ä»¶: $DRAFT_FILE"
            echo "draft_exists=true" >> $GITHUB_OUTPUT
            echo "draft_file=$DRAFT_FILE" >> $GITHUB_OUTPUT
          else
            echo "æœªå‘ç°draftæ–‡ä»¶: $DRAFT_FILE"
            echo "draft_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Agent 1 - æ€»ç¼–è¾‘ï¼ˆåˆ†ç±»å’Œç»“æ„åŒ–ï¼‰
        if: steps.check_draft.outputs.draft_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 1: æ€»ç¼–è¾‘"
          cd books-ai-publishing
          python3 scripts/agent1_chief_editor.py \
            --input "drafts/${{ steps.check_draft.outputs.draft_file }}"

      - name: Agent 2 - æ³¨ç–å¸ˆï¼ˆå­¦æœ¯æ³¨é‡Šï¼‰
        if: steps.check_draft.outputs.draft_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 2: æ³¨ç–å¸ˆ"
          cd books-ai-publishing
          python3 scripts/agent2_annotator.py

      - name: Agent 3 - AIæˆ˜ç•¥å®¶ï¼ˆç°ä»£æ˜ å°„ï¼‰
        if: steps.check_draft.outputs.draft_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 3: AIæˆ˜ç•¥å®¶"
          cd books-ai-publishing
          python3 scripts/agent3_ai_strategist.py

      - name: Agent 4 - æ ¡å¯¹ç¥ï¼ˆè´¨é‡æ§åˆ¶ï¼‰
        if: steps.check_draft.outputs.draft_exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– å¯åŠ¨ Agent 4: æ ¡å¯¹ç¥"
          cd books-ai-publishing
          python3 scripts/agent4_proofreader.py

      - name: æäº¤å¤„ç†ç»“æœ
        if: steps.check_draft.outputs.draft_exists == 'true'
        run: |
          git config --global user.name "AI Publishing Bot"
          git config --global user.email "ai-bot@three-books.ai"

          git add books-ai-publishing/annotations/
          git add books-ai-publishing/ai-parallels/
          git add books-ai-publishing/proofread/

          TODAY=$(date +%Y-%m-%d)
          git commit -m "feat: AIæ³¨ç–å®Œæˆ - $TODAY

          - âœ… Agent 1: åˆ†ç±»å’Œç»“æ„åŒ–
          - âœ… Agent 2: å­¦æœ¯æ³¨ç–
          - âœ… Agent 3: AIæˆ˜ç•¥åˆ†æ
          - âœ… Agent 4: æ ¡å¯¹æ¶¦è‰²

          Generated by AI Publishing System"

          git push

      - name: å‘é€é€šçŸ¥ï¼ˆå¦‚æœå¤±è´¥ï¼‰
        if: failure()
        run: |
          echo "âŒ æ¯æ—¥AIæ³¨ç–å¤„ç†å¤±è´¥"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å’ŒAPIé…ç½®"

  summary:
    runs-on: ubuntu-latest
    needs: process-daily-draft
    if: always()

    steps:
      - name: ç”Ÿæˆå¤„ç†æ‘˜è¦
        run: |
          echo "ğŸ“Š æ¯æ—¥AIæ³¨ç–å¤„ç†æ‘˜è¦"
          echo "æ—¥æœŸ: $(date +%Y-%m-%d)"
          echo "çŠ¶æ€: ${{ needs.process-daily-draft.result }}"
